<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">homework/lib/workers.js</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  </ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">homework/lib/workers.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * Worker rekated task
 */

// Dependencias
let util = require(&apos;util&apos;);
let debug = util.debuglog(&apos;lib&apos;);

// Dependencias de la aplicaci&#xF3;n
let _logs = require(&apos;./logs&apos;);

let lib = {};

lib.log = function (logFileName, message, code, state) {
    if (message &amp;&amp; logFileName) {
        let time = Date.now();
        if (typeof (message) === &apos;object&apos;) {
            message = JSON.stringify(message);
        }
        code = typeof (code) === &apos;number&apos; ? code : 404;
        state = typeof (state) === &apos;string&apos; ? state : &apos;notFound&apos;;

        let logData = {
            &apos;message&apos;: message,
            &apos;code&apos;: code,
            &apos;state&apos;: state,
            &apos;time&apos;: time,
        };

        let logString = JSON.stringify(logData);

        _logs.append(logFileName, logString, function (err) {
            if (!err) {
                debug(&apos;Se ha registrado con exito el evento.&apos;);
            } else {
                debug(&apos;Error al registrar el log.&apos;);
            }
        });
    } else {
        debug(&apos;No se ha agregado ning&#xFA;n mensaje para el registro del log&apos;);
    }
};

// Rotaci&#xF3;n de los logs
lib.rotateLogs = function () {
    // Lista de todos los archivos log que no han sido comprimidos
    _logs.list(false, function (err, logs) {
        if (!err &amp;&amp; logs &amp;&amp; logs.length &gt; 0) {
            logs.forEach(function (logName) {
                // Comprimir los datos y guardarlos en otro archivo
                let logId = logName.replace(&apos;.log&apos;, &apos;&apos;);
                let newFileId = `${logId}-${Date.now()}`;
                _logs.compress(logId, newFileId, function (err) {
                    if (!err) {
                        // Truncar el archivo log
                        _logs.truncate(logId, function (err) {
                            if (!err) {
                                debug(&apos;Success: se ha truncado el archivo log&apos;);
                            } else {
                                debug(&apos;Error: al truncar el archivo log&apos;);
                            }
                        });
                    } else {
                        debug(&apos;Error: al comprimir uno de los archivos: &apos;, err);
                    }
                });
            });
        } else {
            debug(&apos;Error: no se encontraron logs para rotar&apos;);
        }
    });
};

// Rotaci&#xF3;n de log una vez por d&#xED;a
lib.logRotationLoop = function () {
    setInterval(function () {
        lib.rotateLogs();
    }, 1000 * 60 * 60 * 24);
};

// Inicializar script
lib.init = function () {
    // Enviar a la consola
    console.log(&apos;\x1b[33m%s\x1b[0m&apos;, &apos;Ejecuci&#xF3;n en segundo plano.&apos;);

    // Comprimir todo los logs
    lib.rotateLogs();
    lib.logRotationLoop();
};

module.exports = lib;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
